*HH_grid*Find CM's natural mother person number*Find all natural children of that mother*Arrange them according to birth order*Keep only the eldest child*Extrapolate mother's first birth by*=================================================================================* Section 0: Directories and Setup*=================================================================================vers 10.1 clear allset more off* global directory /Users/pedm/Documents/jobs/Damian-Clarke/Data/global directory "C:\Users\pedm\Documents\MyResearch\MCS\MCS-QQ\Data\"pause on*=================================================================================* Section 1: Loop over Waves 1 and 2* Prevents missing values - some cohort members first enter at Wave2*=================================================================================foreach num in 1 2 3 4 5 {	if `num' == 1{		local HHGrid "${directory}Raw/MCS-Survey-1/stata9/mcs1_hhgrid.dta"		local prefix AH		local loopend K	}		if `num' == 2{		local HHGrid "${directory}Raw/MCS-Survey-2/stata9_se/mcs2_hhgrid.dta"		local prefix BH		local loopend R	}		if `num' == 3{		local HHGrid "${directory}Raw/MCS-Survey-3/stata9_se/mcs3_hhgrid.dta"		local prefix CH		local loopend Y	}		if `num' == 4{		local HHGrid "${directory}Raw/MCS-Survey-4/stata9_se/mcs4_hhgrid.dta"		local prefix DH		local loopend Y	}		if `num' == 5{		local HHGrid "${directory}Intermediate/mcs5_hhgrid_with_gender.dta"		local prefix EH		local loopend X				* Oddity: EHPSEX00 not included. Will need to obtain Person_Sex elsewhere		use "${directory}Raw/MCS-Survey-5/stata11/mcs5_hhgrid.dta", clear		sort MCSID EHPNUM00		* TODO: Does this result in fewer mothers? Perhaps we could use HHGrid 4 gender		merge MCSID EHPNUM00 using "${directory}Intermediate/parent-gender.dta"		rename EPPSEX00 EHPSEX00		drop if _merge == 2		drop _merge		save "${directory}Intermediate/mcs5_hhgrid_with_gender.dta", replace		* TODO: Fewer mothers in this wave???	}	*=================================================================================	* Section 2: Find CM's natural mother person number	*=================================================================================	use `HHGrid', clear	sort MCSID	save `HHGrid', replace	* __CREL00: Relationship to Cohort Member	* __PNUM00: Person number	* __PSEX00: Person Sex	* __PDBY00: Person's DOB (year)	* __PDBM00: Person's DOB (month)	rename `prefix'CREL00 Relation_to_CM	rename `prefix'PNUM00 Person_Number	rename `prefix'PSEX00 Person_Sex	rename `prefix'PDBY00 P_DOB_Y	rename `prefix'PDBM00 P_DOB_M	keep if Relation_to_CM == 7 & Person_Sex == 2/*		We now have natural mothers		Now we must create a new variable for all members of the HH that equals the		natural mothers number		Can do so by merging again using HH_grid on MCSID*/	keep MCSID Person_Number P_DOB_Y P_DOB_M 	rename Person_Number Nat_Mom_No	lab var Nat_Mom_No "PNUM of Natural Mother of CM"	rename P_DOB_Y Mother_DOB_Y	rename P_DOB_M Mother_DOB_M/*		Might wish to check if there is more than one nat mom per HH		duplicates report MCSID*/	save "${directory}Intermediate/temp.dta", replace	* Currently all rows are natural parents		sort MCSID	merge MCSID using `HHGrid'	rename `prefix'CREL00 Rel_CM	sort MCSID	* Wave1: 81 observation (26 HH) don't have a natural mother	* Wave2: 440 observations don't have a natural mother	tab _merge		keep if _merge != 2	drop _merge		* TODO: Perhaps compile a dta with the natural mom for each child (over all waves... since sometimes we have no response for one wave but not another)			*=================================================================================	* Section 3: Find all natural children of that mother	*=================================================================================	sort Nat_Mom_No MCSID	save "${directory}Intermediate/temp1.dta", replace	*Erasing all values from relationship to person 1-11 (A-K)	local counter = 1	foreach var of varlist `prefix'PREL0A-`prefix'PREL0`loopend' {		replace `var' = . if Nat_Mom_No != `counter'		local ++counter	}/*		Getting for each member of HH its relation to the natural mother		of CM from that HH*/	egen relation_to_family_mom = rowfirst(`prefix'PREL0*)	*Keeping only natural children of the natural mother of CM	keep if relation_to_family_mom == 3	rename `prefix'PDBY00 P_DOB_Y	rename `prefix'PDBM00 P_DOB_M	rename `prefix'PNUM00 PNUM		rename `prefix'CDBM00 CM_DOB_M	rename `prefix'CDBY00 CM_DOB_Y	rename `prefix'PSEX00 PSEX	rename `prefix'CSEX00 CSEX	* Save now, to use again for finding birth order of CM and birth order of later twins	* But, use HHGrid 5	* Keep only CMs, Nat Siblings, and Half Siblings	* TODO: Why are there some step siblings here? And grandparents?	* (Even if it's just ~15 out of place)	tab Rel_CM	keep if Rel_CM == 11 | Rel_CM==96 | Rel_CM==12	* Give DOBs to CM	replace P_DOB_Y = CM_DOB_Y if P_DOB_Y < 0	replace P_DOB_M = CM_DOB_M if P_DOB_M < 0	replace P_DOB_Y = . if P_DOB_Y < 0	replace P_DOB_M = . if P_DOB_M < 0	replace CSEX = . if CSEX < 0	replace PSEX = . if PSEX < 0			* Record child sex -> later used to find sex of first born child	gen child_sex = PSEX	replace child_sex = CSEX if child_sex == .	gen problem = 0	replace problem = 1 if P_DOB_Y == . | P_DOB_M == .	tab problem	tab Rel_CM if problem == 1/*	Number of siblings missing DOB	wave1: 22	wave2: 34	wave3: 7	wave4: 0	wave5: 0*/	* Drop "Dont know" observations	drop if P_DOB_Y < 0 | P_DOB_M < 0	drop if P_DOB_Y ==. | P_DOB_M ==.	sort MCSID PNUM	save "${directory}Intermediate/natural_children_of_CM_mom_wave`num'.dta", replace	duplicates report MCSID P_DOB_Y P_DOB_M	sort MCSID P_DOB_Y P_DOB_M	*=================================================================================	* Section 4: Getting person's age and mom's age	*=================================================================================	rename P_DOB_Y Child_DOB_Y	rename P_DOB_M Child_DOB_M	*Drop observation with mother's unknown year of birth (9 obs)	drop if Mother_DOB_Y < 0	*Drop observation with mother's unknown month of birth (9 obs)	drop if Mother_DOB_M < 0	*Drop observation with child's unknown year of birth (0 obs)	drop if Child_DOB_Y < 0	*Drop observation with child's unknown month of birth (11 obs)	drop if Child_DOB_M < 0	gen Mom_Age = 2014 - Mother_DOB_Y + (8 - Mother_DOB_M) / 12	gen Child_Age = 2014 - Child_DOB_Y + (8 - Child_DOB_M) / 12		* For each family, count how many children are present	by MCSID: egen children_present = count(Child_DOB_Y != .)	* For each family, count how many children are present pre 1990	gen pre_1990 = Child_DOB_Y <= 1990	by MCSID: egen children_pre_1990 = sum(pre_1990)	* For each family, count how many children are present pre 1995	gen pre_1995 = Child_DOB_Y <= 1995	by MCSID: egen children_pre_1995 = sum(pre_1995)			* TODO: See if pre 1995 kids are same for all families in waves 4 and 5	* Current finding: waves 4 and 5 do not have any missing DOBs.				*=================================================================================	* Section 5: Extrapolating mom's age at birth and thus at first birth	*=================================================================================		gen Mom_Age_At_Birth = Mom_Age - Child_Age	drop if Mom_Age_At_Birth < 0	egen agefirstbirth = min(Mom_Age_At_Birth), by(MCSID)		* Record child sex -> later used to find sex of first born child	* Drop out the non first born	keep if agefirstbirth == Mom_Age_At_Birth	* Drop child sex if non-singleton first birth	keep MCSID agefirstbirth child_sex	duplicates tag, gen(dup)	replace child_sex = . if dup > 0	rename child_sex first_child_sex	label var first_child_sex "Sex of first child. Give . for non-singleton first birth"	label var agefirstbirth "Mother Age at First Birth, calculated by Natural Children of Nat Mom"	*histogram agefirstbirth	keep MCSID agefirstbirth first_child_sex	duplicates drop	save "${directory}Intermediate/agefirstbirth_wave`num'.dta", replace}*=================================================================================* Section 6: Combine agefirstbirth from waves 1 - 4*=================================================================================use "${directory}Intermediate/agefirstbirth_wave1.dta", cleargen wave = 1foreach num in 2 3 4 5 {	append using "${directory}Intermediate/agefirstbirth_wave`num'.dta"	replace wave = `num' if wave == .}* TODO* Perhaps I should merge together the list of natural children, remove duplicates and any without DOB* That will prevent the different age calculations I'm finding*Test for different age calculationsduplicates tag MCSID agefirstbirth, gen(sameage_samemother)duplicates tag MCSID, gen(samemother)tab sameage_samemother samemother* There agefirstbirth are clearly inconsistent:* edit if sameage_samemother == 0 & samemother == 1* Waves 4 and 5 have no missing DOBs, thus they are most reliablegsort -waveduplicates drop MCSID agefirstbirth, forceduplicates report MCSIDduplicates tag MCSID, gen(dup)preservesort MCSID wave* This shows all mothers with inconsistent agefirstbirth**** edit if dup > 0restoreduplicates drop MCSID, force* 602 mothers have different agefirstbirth calculations (depending on wave)tab wavesum agefirstbirthduplicates drop MCSID, forcesort MCSIDtab wavedrop wavesave "${directory}Intermediate/agefirstbirth.dta", replace